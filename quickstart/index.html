<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pal Mickey IR Command Center & Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        body { background-color: #f0f2f5; min-height: 100vh; padding: 20px 0; font-family: 'Segoe UI', sans-serif; }
        .card { border: none; box-shadow: 0 15px 35px rgba(0,0,0,0.1); border-radius: 16px; }
        #terminal { font-family: 'Courier New', monospace; height: 180px; background: #1e1e1e; color: #0dfd05; font-size: 0.85rem; border-radius: 8px; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .bg-disconnected { background-color: #dc3545; }
        .bg-connected { background-color: #198754; }
        .hex-input { font-family: 'Courier New', monospace; text-transform: uppercase; letter-spacing: 2px; text-align: center; font-weight: bold; border: 2px solid #dee2e6; }
        .scanning { animation: pulse-yellow 1.5s infinite; }
        @keyframes pulse-yellow { 0% { box-shadow: 0 0 0 0px rgba(255, 193, 7, 0.7); } 100% { box-shadow: 0 0 0 15px rgba(255, 193, 7, 0); } }
    </style>
</head>
<body>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg">
                <div class="card-header bg-dark text-white p-4 d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0"><i data-feather="search" class="me-2"></i> Pal Mickey Explorer</h4>
                        <small class="text-secondary">Web Serial Discovery Tool</small>
                    </div>
                    <div class="d-flex gap-2">
                        <select id="baudRate" class="form-select form-select-sm" style="width: auto;">
                            <option value="2400" selected>2400 baud</option>
                        </select>
                        <button id="connectBtn" class="btn btn-primary btn-sm px-3">Connect</button>
                    </div>
                </div>

                <div class="card-body p-4">
                    <div class="mb-3 d-flex align-items-center">
                        <span id="statusDot" class="status-dot bg-disconnected"></span>
                        <span id="statusText" class="text-muted small fw-bold">DISCONNECTED</span>
                    </div>

                    <div class="row g-4">
                        <div class="col-md-6 border-end">
                            <h6 class="fw-bold mb-3 text-primary">Manual Trigger</h6>
                            <label class="small fw-bold">Park (SS PP)</label>
                            <select id="parkSelect" class="form-select mb-3">
                                <option value="0701">Magic Kingdom (07 01)</option>
                                <option value="0702">Epcot (07 02)</option>
                                <option value="0703">Hollywood Studios (07 03)</option>
                                <option value="0704">Animal Kingdom (07 04)</option>
                            </select>

                            <label class="small fw-bold">Location (XX YY)</label>
                            <input type="text" id="manualLoc" class="form-control hex-input mb-3" maxlength="4" value="0101" placeholder="HEX">
                            
                            <button id="blastBtn" class="btn btn-warning w-100 fw-bold" disabled>
                                <i data-feather="zap"></i> BLAST SINGLE
                            </button>
                        </div>

                        <div class="col-md-6">
                            <h6 class="fw-bold mb-3 text-danger">Discovery Scanner</h6>
                            <label class="small fw-bold">Interval (ms)</label>
                            <input type="number" id="scanDelay" class="form-control mb-3" value="1500" step="100" min="500">
                            
                            <div class="alert alert-light border small py-2 mb-3 text-muted">
                                <strong>Tip:</strong> Slower intervals help Mickey finish his lines before the next trigger.
                            </div>

                            <button id="scanBtn" class="btn btn-outline-danger w-100 fw-bold" disabled>
                                <i data-feather="play"></i> START AUTO-SCAN
                            </button>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="text-center mb-3">
                        <span class="badge bg-dark p-3 fs-6 w-100">
                            Current Payload: <span id="fullPayload" class="font-monospace text-warning">07010801</span>
                        </span>
                    </div>

                    <textarea id="terminal" class="form-control" readonly placeholder="Activity log..."></textarea>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <small class="text-muted">TX Format: <code class="text-primary">8 Chars + \n</code></small>
                        <button id="clearBtn" class="btn btn-link btn-sm text-decoration-none text-muted">Clear Log</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    feather.replace();

    let port, writer, scanInterval;
    let isScanning = false;

    const connectBtn = document.getElementById('connectBtn');
    const blastBtn = document.getElementById('blastBtn');
    const scanBtn = document.getElementById('scanBtn');
    const parkSelect = document.getElementById('parkSelect');
    const manualLoc = document.getElementById('manualLoc');
    const fullPayloadDisplay = document.getElementById('fullPayload');
    const terminal = document.getElementById('terminal');
    const statusDot = document.getElementById('statusDot');

    function getFinalPayload() {
        let cleanLoc = manualLoc.value.toUpperCase().replace(/[^0-9A-F]/g, '').padStart(4, '0');
        return parkSelect.value + cleanLoc;
    }

    function updateUI() {
        let currentInput = manualLoc.value.toUpperCase().replace(/[^0-9A-F]/g, '');
        fullPayloadDisplay.innerText = parkSelect.value + currentInput.padStart(4, '0');
    }

    manualLoc.addEventListener('input', updateUI);
    parkSelect.addEventListener('change', updateUI);

    manualLoc.addEventListener('blur', () => {
        manualLoc.value = manualLoc.value.toUpperCase().replace(/[^0-9A-F]/g, '').padStart(4, '0');
        updateUI();
    });

    manualLoc.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            manualLoc.blur(); 
            if(!blastBtn.disabled) transmit(getFinalPayload());
        }
    });

    connectBtn.addEventListener('click', async () => {
        if (port) { location.reload(); return; } 
        try {
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: 2400 });
            statusDot.className = "status-dot bg-connected";
            document.getElementById('statusText').innerText = "CONNECTED";
            connectBtn.innerText = "Disconnect";
            blastBtn.disabled = false;
            scanBtn.disabled = false;
            log("System Connected. 2400 baud handshake ready.");
        } catch (err) { Swal.fire('Error', err.message, 'error'); }
    });

    async function transmit(code) {
        if (!port || !port.writable) return;
        try {
            const encoder = new TextEncoder();
            const writer = port.writable.getWriter();
            await writer.write(encoder.encode(code + "\n"));
            writer.releaseLock();
            log(`TX: ${code}`);
            return true;
        } catch (e) { log(`Error: ${e.message}`); return false; }
    }

    blastBtn.addEventListener('click', () => transmit(getFinalPayload()));

    scanBtn.addEventListener('click', () => {
        isScanning ? stopScan() : startScan();
    });

    function startScan() {
        isScanning = true;
        scanBtn.innerHTML = `<i data-feather="square"></i> STOP SCANNER`;
        scanBtn.classList.replace('btn-outline-danger', 'btn-danger');
        scanBtn.classList.add('scanning');
        feather.replace();
        log("Scanner Started. Stepping through Location IDs...");

        const delay = parseInt(document.getElementById('scanDelay').value);
        
        scanInterval = setInterval(async () => {
            let currentHex = parseInt(manualLoc.value, 16) || 0;
            currentHex++;
            manualLoc.value = currentHex.toString(16).toUpperCase().padStart(4, '0');
            updateUI();
            await transmit(getFinalPayload());
        }, delay);
    }

    function stopScan() {
        isScanning = false;
        clearInterval(scanInterval);
        scanBtn.innerHTML = `<i data-feather="play"></i> START AUTO-SCAN`;
        scanBtn.classList.replace('btn-danger', 'btn-outline-danger');
        scanBtn.classList.remove('scanning');
        feather.replace();
        log("Scanner Paused.");
    }

    function log(msg) {
        const ts = new Date().toLocaleTimeString([], { 
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit', 
            hour12: false 
        });
        terminal.value += `[${ts}] ${msg}\n`;
        terminal.scrollTop = terminal.scrollHeight;
    }

    document.getElementById('clearBtn').addEventListener('click', () => terminal.value = '');
</script>
</body>
</html>